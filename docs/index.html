<title>截图os识别</title>
<style>
body{
  text-align: center;
}
</style>

<body>
  <div class="container">

    <canvas id="show"></canvas>
    <br>
    <br>

    <input id="file" type="file">

    <p id="msg">加载模型中</p>

  </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"> </script> 

<script>

  var reader = new FileReader(), img = new Image();

// 选择的文件对象
var file = null;

// 缩放图片需要的canvas
var canvas = document.createElement('canvas');
var show = document.getElementById('show');
var context = canvas.getContext('2d');
var show_con = show.getContext('2d');

// base64地址图片加载完毕后
img.onload = function () {
  // 图片原始尺寸
  var originWidth = this.width, originHeight = this.height;

  var maxWidth = 400, maxHeight = 400;
  // 目标尺寸
  var targetWidth = originWidth, targetHeight = originHeight;
  // 图片尺寸超过400x400的限制
  if (originWidth > maxWidth || originHeight > maxHeight) {
    if (originWidth / originHeight > maxWidth / maxHeight) {
      // 更宽，按照宽度限定尺寸
      targetWidth = maxWidth;
      targetHeight = Math.round(maxWidth * (originHeight / originWidth));
    } else {
      targetHeight = maxHeight;
      targetWidth = Math.round(maxHeight * (originWidth / originHeight));
    }
  }
  // canvas对图片进行缩放
  canvas.width = originWidth;
  canvas.height = originHeight;
  show.width = targetWidth;
  show.height = targetHeight;
  //context.clearRect(0, 0, originWidth, originHeight);
  context.drawImage(img, 0, 0);
  //show_con.clearRect(0, 0, targetWidth, targetHeight);
  show_con.drawImage(img, 0, 0, targetWidth, targetHeight);
  var image = context.getImageData(0, 0, originWidth, originHeight);
  predict(image);
};
reader.onload = function(e) {
  img.src = e.target.result;
  document.getElementById("msg").innerText="识别中";
};
addEventListener('change', function (event) {
  document.getElementById("msg").innerText="上传中";
  file = event.target.files[0];
  // 选择的文件是图片
  if (file.type.indexOf("image") == 0) {
    reader.readAsDataURL(file);    
  }
});
</script>

<script>

  let model;
const system = ['iOS', 'EMUI', 'One UI', 'MIUI'];

loadModel();

async function loadModel() {
  model = await tf.loadLayersModel("https://api.buzhibujue.cf/mobilenet/model.json");
  model.summary();
  console.log("Load model successfully.");
  document.getElementById("msg").innerText="模型加载完成";
}

async function predict(img) {
  if (model == null) return;
  const imgData = {
    data: new Uint8Array(img.data), 
    width: img.width, 
    height: img.height
  };
  const imgSlice = tf.tidy(() => {
    const imgTensor = tf.browser.fromPixels(imgData, 4);
    const realImgTensor = imgTensor.slice([0, 0, 0], [-1, -1, 3]).expandDims(0);
    const divisor = tf.scalar(255);
    return tf.div(tf.image.cropAndResize(realImgTensor, [[0, 0, 0.06*img.width/img.height, 1]], [0], [32, 512]),divisor);
  });
  const res = await model.predict(imgSlice);
  console.log('Completed');
  console.log(res.squeeze().dataSync());
  const y = res.squeeze().dataSync();
  max_index=0
  for (var i = 0; i < y.length; ++i)
    if (y[i] >y[max_index])max_index=i;
  document.getElementById("msg").innerText="识别结果为："+system[max_index];
  console.log("识别结果为："+system[max_index]);
}
</script>
